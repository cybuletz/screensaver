<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - Google Photos Screensaver</title>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
            background-color: #f5f5f5;
        }
        
        .settings-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .album-list {
            margin-bottom: 20px;
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 5px;
        }

        .album-item {
            margin-bottom: 10px;
            padding: 5px;
        }

        .option-group {
            margin-bottom: 15px;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        .sub-option {
            margin-left: 20px;
            margin-top: 10px;
        }

        label {
            display: inline-block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        select, input[type="number"], input[type="time"] {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
            width: 200px;
        }

        .color-picker {
            padding: 0;
            width: 50px;
            height: 30px;
        }

        button {
            background-color: #4285f4;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }

        .auth-button {
            display: inline-block;
            background-color: #4285f4;
            color: white;
            padding: 12px 24px;
            text-decoration: none;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .preview-box {
            width: 200px;
            height: 100px;
            border: 1px solid #ddd;
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: black;
            color: white;
            font-family: 'Digital', monospace;
        }
		
		.weather-overlay {
			position: absolute;
			top: 20px;
			right: 20px;
			padding: 15px;
			background: rgba(0, 0, 0, 0.5);
			color: white;
			border-radius: 5px;
			display: flex;
			align-items: center;
			gap: 10px;
			z-index: 1000;
		}

		.weather-overlay img {
			width: 50px;
			height: 50px;
		}
    </style>
</head>
<body>
    <h1>Screensaver Settings</h1>
    <a href="/auth" class="auth-button">Authenticate with Google</a>

    <form id="settings-form" style="display:none;">
        <!-- Display Settings -->
        <div class="settings-section">
            <h2>Display Settings</h2>
            <div class="option-group">
                <label for="resolution">Display Resolution:</label>
                <select id="resolution" name="resolution">
                    <option value="auto">Auto-detect</option>
                    <option value="1920x1080">1080p (1920x1080)</option>
                    <option value="2560x1440">1440p (2560x1440)</option>
                    <option value="3840x2160">4K (3840x2160)</option>
                </select>
            </div>

            <div class="option-group">
                <label for="fitMode">Image Fit Mode:</label>
                <select id="fitMode" name="fitMode">
                    <option value="cover">Fill Screen</option>
                    <option value="contain">Maintain Aspect Ratio</option>
                    <option value="stretch">Stretch to Fill</option>
                </select>
            </div>
        </div>

        <!-- Clock Overlay Settings -->
        <div class="settings-section">
            <h2>Clock Overlay</h2>
            <div class="option-group">
                <input type="checkbox" id="showClock" name="showClock" checked>
                <label for="showClock">Show Clock Overlay</label>
                
                <div class="sub-option">
                    <label for="clockStyle">Clock Style:</label>
                    <select id="clockStyle" name="clockStyle">
                        <option value="digital">Digital</option>
                        <option value="analog">Analog</option>
                    </select>
                </div>

                <div class="sub-option">
                    <label for="clockFormat">Time Format:</label>
                    <select id="clockFormat" name="clockFormat">
                        <option value="24">24-hour</option>
                        <option value="12">12-hour</option>
                    </select>
                </div>

                <div class="sub-option">
                    <label for="clockPosition">Position:</label>
                    <select id="clockPosition" name="clockPosition">
                        <option value="top-left">Top Left</option>
                        <option value="top-right">Top Right</option>
                        <option value="bottom-left">Bottom Left</option>
                        <option value="bottom-right">Bottom Right</option>
                        <option value="center">Center</option>
                    </select>
                </div>

                <div class="sub-option">
                    <label for="clockColor">Color:</label>
                    <input type="color" id="clockColor" name="clockColor" value="#ffffff" class="color-picker">
                </div>

                <div class="sub-option">
                    <label for="clockSize">Size:</label>
                    <select id="clockSize" name="clockSize">
                        <option value="small">Small</option>
                        <option value="medium">Medium</option>
                        <option value="large">Large</option>
                    </select>
                </div>

                <div class="preview-box" id="clockPreview">
                    12:00:00
                </div>
            </div>
        </div>

        <!-- Slideshow Settings -->
        <div class="settings-section">
            <h2>Slideshow Settings</h2>
            <div class="option-group">
                <label for="interval">Change Picture Every (seconds):</label>
                <input type="number" id="interval" name="interval" min="5" max="3600" value="30">
            </div>

            <div class="option-group">
                <label for="transition">Transition Effect:</label>
                <select id="transition" name="transition">
                    <option value="fade">Fade</option>
                    <option value="slide">Slide</option>
                    <option value="zoom">Zoom</option>
                    <option value="blur">Blur</option>
                    <option value="none">None</option>
                </select>
            </div>

            <div class="option-group">
                <label for="transitionDuration">Transition Duration (seconds):</label>
                <input type="number" id="transitionDuration" name="transitionDuration" min="0.5" max="5" step="0.5" value="1">
            </div>

            <div class="option-group">
                <input type="checkbox" id="shuffle" name="shuffle" checked>
                <label for="shuffle">Shuffle Images</label>
            </div>
        </div>

        <!-- Schedule Settings -->
        <div class="settings-section">
            <h2>Schedule Settings</h2>
            <div class="option-group">
                <input type="checkbox" id="enableSchedule" name="enableSchedule">
                <label for="enableSchedule">Enable Schedule</label>

                <div class="sub-option">
                    <label for="startTime">Start Time:</label>
                    <input type="time" id="startTime" name="startTime" value="09:00">
                </div>

                <div class="sub-option">
                    <label for="endTime">End Time:</label>
                    <input type="time" id="endTime" name="endTime" value="17:00">
                </div>

                <div class="sub-option">
                    <label for="daysActive">Active Days:</label>
                    <div id="daysActive">
                        <input type="checkbox" id="day-mon" name="daysActive" value="1">
                        <label for="day-mon">Mon</label>
                        <input type="checkbox" id="day-tue" name="daysActive" value="2">
                        <label for="day-tue">Tue</label>
                        <input type="checkbox" id="day-wed" name="daysActive" value="3">
                        <label for="day-wed">Wed</label>
                        <input type="checkbox" id="day-thu" name="daysActive" value="4">
                        <label for="day-thu">Thu</label>
                        <input type="checkbox" id="day-fri" name="daysActive" value="5">
                        <label for="day-fri">Fri</label>
                        <input type="checkbox" id="day-sat" name="daysActive" value="6">
                        <label for="day-sat">Sat</label>
                        <input type="checkbox" id="day-sun" name="daysActive" value="0">
                        <label for="day-sun">Sun</label>
                    </div>
                </div>
            </div>
        </div>
		
		
<!-- Weather Settings -->
<div class="settings-section">
    <h2>Weather Settings</h2>
    <div class="option-group">
        <label for="showWeather">Show Weather:</label>
        <input type="checkbox" id="showWeather" name="showWeather">
        
        <div class="sub-option">
            <label for="weatherCity">Weather City:</label>
            <input type="text" id="weatherCity" name="weatherCity" placeholder="Enter city name">
        </div>
    </div>
</div>



        <!-- Album Selection -->
        <div class="settings-section">
            <h2>Selected Albums</h2>
            <div class="album-list" id="album-list">
                <!-- Albums will be dynamically inserted here -->
            </div>
        </div>

        <button type="submit">Save Settings</button>
    </form>
	
<!-- Script section -->

<script>
    async function fetchAlbums() {
        try {
            log('Attempting to fetch albums...');
            const response = await fetch('/fetch-albums');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const albums = await response.json();
            log(`Received ${albums.length} albums`);

            const albumList = document.getElementById('album-list');
            albumList.innerHTML = ''; // Clear existing content

            albums.forEach(album => {
                const div = document.createElement('div');
                div.className = 'album-item';
                div.innerHTML = `
                    <input type="checkbox" id="${album.id}" name="albums" value="${album.id}">
                    <label for="${album.id}">${album.title || 'Untitled Album'}</label>
                `;
                albumList.appendChild(div);
            });

            // Show the form after albums are loaded
            document.getElementById('settings-form').style.display = 'block';
            
            // Load previously selected albums
            const selectedAlbums = JSON.parse(localStorage.getItem('selectedAlbums')) || [];
            selectedAlbums.forEach(albumId => {
                const checkbox = document.querySelector(`input[name="albums"][value="${albumId}"]`);
                if (checkbox) checkbox.checked = true;
            });

        } catch (error) {
            console.error('Error fetching albums:', error);
            // If authentication error, redirect to auth
            if (error.message.includes('401')) {
                window.location.href = '/auth';
            }
        }
    }

    function loadSavedSettings() {
        const settings = JSON.parse(localStorage.getItem('screensaverSettings')) || {
            resolution: 'auto',
            fitMode: 'cover',
            showClock: true,
            clockStyle: 'digital',
            clockFormat: '24',
            clockPosition: 'bottom-right',
            clockColor: '#ffffff',
            clockSize: 'medium',
            interval: 30,
            transition: 'fade',
            transitionDuration: 1,
            shuffle: true,
            enableSchedule: false,
            startTime: '09:00',
            endTime: '17:00',
            daysActive: [1,2,3,4,5]
			showWeather: true,  
			weatherCity: 'Bucharest' 
        };

        // Apply settings to form
        Object.entries(settings).forEach(([key, value]) => {
            const element = document.getElementById(key);
            if (element) {
                if (element.type === 'checkbox') {
                    element.checked = value;
                } else {
                    element.value = value;
                }
            }
        });

        // Handle days active
        if (settings.daysActive) {
            settings.daysActive.forEach(day => {
                const dayElement = document.querySelector(`input[name="daysActive"][value="${day}"]`);
                if (dayElement) dayElement.checked = true;
            });
        }

        updateClockPreview();
    }

    function updateClockPreview() {
        const preview = document.getElementById('clockPreview');
        if (!preview) return;

        const color = document.getElementById('clockColor').value;
        const size = document.getElementById('clockSize').value;
        const style = document.getElementById('clockStyle').value;
        
        preview.style.color = color;
        preview.style.fontSize = size === 'small' ? '16px' : size === 'medium' ? '24px' : '32px';
        
        if (style === 'digital') {
            const now = new Date();
            preview.textContent = now.toLocaleTimeString();
        } else {
            preview.textContent = 'ðŸ•';
        }
    }

    document.getElementById('settings-form').addEventListener('submit', async function (e) {
        e.preventDefault();
        
        try {
            // Save selected albums
            const selectedAlbums = Array.from(document.querySelectorAll('input[name="albums"]:checked'))
                .map(checkbox => checkbox.value);
            localStorage.setItem('selectedAlbums', JSON.stringify(selectedAlbums));

            // Save other settings
            const settings = {
                resolution: document.getElementById('resolution').value,
                fitMode: document.getElementById('fitMode').value,
                showClock: document.getElementById('showClock').checked,
                clockStyle: document.getElementById('clockStyle').value,
                clockFormat: document.getElementById('clockFormat').value,
                clockPosition: document.getElementById('clockPosition').value,
                clockColor: document.getElementById('clockColor').value,
                clockSize: document.getElementById('clockSize').value,
                interval: parseInt(document.getElementById('interval').value),
                transition: document.getElementById('transition').value,
                transitionDuration: parseFloat(document.getElementById('transitionDuration').value),
                shuffle: document.getElementById('shuffle').checked,
                enableSchedule: document.getElementById('enableSchedule').checked,
                startTime: document.getElementById('startTime').value,
                endTime: document.getElementById('endTime').value,
                daysActive: Array.from(document.querySelectorAll('input[name="daysActive"]:checked'))
                    .map(checkbox => parseInt(checkbox.value))
				showWeather: document.getElementById('showWeather').checked,     // Add this
				weatherCity: document.getElementById('weatherCity').value   
            };
            
            localStorage.setItem('screensaverSettings', JSON.stringify(settings));

            alert('Settings saved! The page will now reload.');
            window.location.href = '/';
            
        } catch (error) {
            console.error('Error saving settings:', error);
            alert('Error saving settings. Please try again.');
        }
    });

    // Event listeners
    if (document.getElementById('clockColor')) {
        document.getElementById('clockColor').addEventListener('input', updateClockPreview);
    }
    if (document.getElementById('clockSize')) {
        document.getElementById('clockSize').addEventListener('change', updateClockPreview);
    }
    if (document.getElementById('clockStyle')) {
        document.getElementById('clockStyle').addEventListener('change', updateClockPreview);
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function () {
        console.log('DOM Content Loaded');
        loadSavedSettings();
        fetchAlbums().catch(console.error);
        
        // Start clock preview update interval
        if (document.getElementById('clockPreview')) {
            setInterval(updateClockPreview, 1000);
        }
    });

    // Debug logging function
    function log(message) {
        console.log(`[${new Date().toISOString()}] ${message}`);
    }
</script>
</body>
</html>
